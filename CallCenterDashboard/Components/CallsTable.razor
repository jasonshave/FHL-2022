@using CallCenterDashboard.Models
@using Azure.Communication.CallingServer
@using Azure.Communication
@using CallCenterDashboard.Features.ActiveCalls
@using CallCenterDashboard.Features.CallingServer

@inherits FluxorComponent
@inject IDispatcher dispatcher
@inject IState<ActiveCallsState> activeCallState


<MudTable Items="@activeCallState.Value.CallData" Hover="true" Breakpoint="Breakpoint.Sm" T="CallData">
    <HeaderContent>
        <MudTh>From</MudTh>
        <MudTh>To</MudTh>
        <MudTh>Call Duration</MudTh>
        <MudTh>Connection ID</MudTh>
        <MudTh>Correlation ID</MudTh>
        <MudTh>Hang up</MudTh>
        <MudTh>Terminate</MudTh>
        <MudTh>Add</MudTh>
        <MudTh>Remove</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="From">@context.From</MudTd>
        <MudTd DataLabel="To">@context.To</MudTd>
        <MudTd DataLabel="Duration(s)">@CalculateDuration(context.CallStartTime).Seconds</MudTd>
        <MudTd DataLabel="Connection ID">@context.CallConnectionId</MudTd>
        <MudTd DataLabel="Correlation ID">@context.CorrelationId</MudTd>
        <MudTd>
            <HangUpButton CallData="context"/>
        </MudTd>
        <MudTd>
            <TerminateButton CallData="context"/>
        </MudTd>
        <MudTd>
            <AddParticipantButton CallData="context"/>
        </MudTd>
        <MudTd>
            <RemoveParticipantButton CallData="context"/>
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    Timer theTimer;

    protected override void OnInitialized()
    {
        theTimer = new Timer(Tick, null, 0, 1000);
        base.OnInitialized();
    }

    private void Tick(object _)
    {
        dispatcher.Dispatch(new ActiveCallsLoadDataAction());
        InvokeAsync(StateHasChanged);
    }

    private TimeSpan CalculateDuration(DateTimeOffset startTime)
    {
        return DateTimeOffset.UtcNow - startTime;
    }

    protected override void Dispose(bool disposing)
    {
        theTimer.Dispose();
        base.Dispose(disposing);
    }
}
